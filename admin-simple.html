<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JeunAct - Administration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background: #f8f9fa; }
        .navbar { background: linear-gradient(135deg, #8B1538 0%, #E91E63 100%); }
        .navbar-brand, .nav-link { color: white !important; }
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: #8B1538; border: none; }
        .btn-primary:hover { background: #6b0f2a; }
        .member-card { background: linear-gradient(135deg, #8B1538 0%, #E91E63 100%); color: white; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; max-width: 400px; width: 100%; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card login-card">
                        <div class="card-body text-center p-5">
                            <h3 class="mb-4" style="color: #8B1538;">
                                <i class="fas fa-shield-alt me-2"></i>Connexion Admin
                            </h3>
                            <form id="loginForm">
                                <div class="mb-4">
                                    <input type="password" class="form-control" id="adminPassword" 
                                           placeholder="Mot de passe administrateur" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mb-3">
                                    <i class="fas fa-sign-in-alt me-2"></i>Se connecter
                                </button>
                            </form>
                            <a href="index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Retour à l'accueil
                            </a>
                            <div class="mt-3">
                                <small class="text-muted">Mot de passe : JeunAct2024Admin</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Interface -->
    <div id="adminInterface" style="display: none;">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="index.html">
                    <i class="fas fa-users me-2"></i>JeunAct Admin
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="index.html">
                        <i class="fas fa-home me-1"></i>Accueil
                    </a>
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                    </a>
                </div>
            </div>
        </nav>

        <main class="container my-5">
            <div id="alertsContainer"></div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: #8B1538;">
                    <i class="fas fa-cog me-2"></i>Administration des Membres
                </h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="showAddMemberModal()">
                        <i class="fas fa-plus me-2"></i>Ajouter un Membre
                    </button>
                    <button class="btn btn-warning" onclick="resetData()">
                        <i class="fas fa-refresh me-2"></i>Réinitialiser
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Déconnexion
                    </button>
                </div>
            </div>

            <div id="membersList" class="row">
                <!-- Les membres seront chargés ici -->
            </div>
        </main>
    </div>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Ajouter un Nouveau Membre
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nom complet *</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Rôle *</label>
                                <select class="form-select" id="role" required onchange="togglePosition()">
                                    <option value="">Sélectionner un rôle</option>
                                    <option value="Bureau">Bureau</option>
                                    <option value="Membre">Membre</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3" id="positionDiv" style="display: none;">
                                <label class="form-label">Poste (si Bureau)</label>
                                <input type="text" class="form-control" id="position" placeholder="Ex: Président, Secrétaire...">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">WhatsApp</label>
                                <input type="text" class="form-control" id="whatsapp" placeholder="212600000000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Instagram</label>
                                <input type="text" class="form-control" id="instagram" placeholder="@username">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">LinkedIn</label>
                                <input type="url" class="form-control" id="linkedin" placeholder="https://linkedin.com/in/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Photo</label>
                                <input type="text" class="form-control" id="photo" placeholder="nom-fichier.jpg">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date d'intégration</label>
                                <input type="date" class="form-control" id="integrationDate">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="button" class="btn btn-success" onclick="addMember()">
                        <i class="fas fa-save me-2"></i>Ajouter le Membre
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-qrcode me-2"></i>QR Code - <span id="qrMemberName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrCodeContainer" class="mb-3"></div>
                    <p class="mb-3">Scannez ce QR code pour accéder au profil du membre</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-success" onclick="downloadQR()">
                            <i class="fas fa-download me-2"></i>Télécharger
                        </button>
                        <button class="btn btn-primary" onclick="printQR()">
                            <i class="fas fa-print me-2"></i>Imprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let membersData = [];
        let currentQRCode = null;

        // Vérifier l'authentification au chargement
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                showAdminInterface();
            } else {
                showLoginScreen();
            }
        });

        // Gestion de la connexion
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'JeunAct2024Admin') {
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminInterface();
            } else {
                showAlert('Mot de passe incorrect.', 'danger');
            }
        });

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminInterface').style.display = 'none';
        }

        function showAdminInterface() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminInterface').style.display = 'block';
            loadMembers();
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            showLoginScreen();
        }

        // Charger les membres
        async function loadMembers() {
            try {
                // D'abord essayer de charger depuis localStorage
                const savedData = localStorage.getItem('jeunact_members');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    membersData = data.members || [];
                    displayMembers();
                    return;
                }
                
                // Si pas de données sauvegardées, charger depuis le fichier JSON
                const response = await fetch('members.json');
                const data = await response.json();
                membersData = data.members;
                
                // Sauvegarder dans localStorage pour la première fois
                localStorage.setItem('jeunact_members', JSON.stringify(data));
                
                displayMembers();
            } catch (error) {
                console.error('Erreur lors du chargement des membres:', error);
                showAlert('Erreur lors du chargement des membres.', 'danger');
            }
        }

        // Afficher les membres
        function displayMembers() {
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';

            if (membersData.length === 0) {
                membersList.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-4x mb-4" style="color: #8B1538;"></i>
                            <h3 style="color: #8B1538;">Aucun membre trouvé</h3>
                            <p style="color: #666;">Commencez par ajouter votre premier membre.</p>
                            <button class="btn btn-primary" onclick="showAddMemberModal()">
                                <i class="fas fa-plus me-2"></i>Ajouter un Membre
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            membersData.forEach(member => {
                const memberCard = `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card member-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">${member.full_name}</h5>
                                    <span class="badge ${member.role === 'Bureau' ? 'bg-warning text-dark' : 'bg-light text-dark'}">
                                        ${member.role === 'Bureau' && member.position ? member.position : member.role}
                                    </span>
                                </div>
                                <p class="mb-2">
                                    <i class="fas fa-hashtag me-1"></i>#${member.member_number}
                                </p>
                                ${member.email ? `<p class="mb-2">
                                    <i class="fas fa-envelope me-1"></i>${member.email}
                                </p>` : ''}
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    ${member.whatsapp ? `<span class="badge bg-success">WhatsApp</span>` : ''}
                                    ${member.instagram ? `<span class="badge bg-danger">Instagram</span>` : ''}
                                    ${member.linkedin ? `<span class="badge bg-primary">LinkedIn</span>` : ''}
                                </div>
                                <div class="btn-group w-100" role="group">
                                    <a href="member/${member.id}.html" 
                                       class="btn btn-light btn-sm" target="_blank">
                                        <i class="fas fa-eye me-1"></i>Voir
                                    </a>
                                    <button type="button" 
                                            class="btn btn-light btn-sm"
                                            onclick="showQRModal(${member.id})">
                                        <i class="fas fa-qrcode me-1"></i>QR
                                    </button>
                                    <button type="button" 
                                            class="btn btn-light btn-sm"
                                            onclick="deleteMember(${member.id})">
                                        <i class="fas fa-trash me-1"></i>Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                membersList.innerHTML += memberCard;
            });
        }

        // Afficher/masquer le champ position
        function togglePosition() {
            const role = document.getElementById('role').value;
            const positionDiv = document.getElementById('positionDiv');
            
            if (role === 'Bureau') {
                positionDiv.style.display = 'block';
            } else {
                positionDiv.style.display = 'none';
                document.getElementById('position').value = '';
            }
        }

        // Afficher le modal d'ajout
        function showAddMemberModal() {
            document.getElementById('addMemberForm').reset();
            document.getElementById('positionDiv').style.display = 'none';
            new bootstrap.Modal(document.getElementById('addMemberModal')).show();
        }

        // Ajouter un membre
        function addMember() {
            const form = document.getElementById('addMemberForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newMember = {
                id: Math.max(...membersData.map(m => m.id), 0) + 1,
                member_number: `MEM${String(membersData.length + 1).padStart(3, '0')}`,
                full_name: document.getElementById('fullName').value,
                role: document.getElementById('role').value,
                position: document.getElementById('role').value === 'Bureau' ? document.getElementById('position').value : null,
                email: document.getElementById('email').value || null,
                whatsapp: document.getElementById('whatsapp').value || null,
                instagram: document.getElementById('instagram').value || null,
                linkedin: document.getElementById('linkedin').value || null,
                photo: document.getElementById('photo').value || null,
                integration_date: document.getElementById('integrationDate').value || new Date().toISOString().split('T')[0],
                created_at: new Date().toISOString()
            };

            membersData.push(newMember);
            saveMembers();
            displayMembers();
            bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
            showAlert('Membre ajouté avec succès !', 'success');
        }

        // Supprimer un membre
        function deleteMember(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce membre ?')) {
                membersData = membersData.filter(m => m.id !== id);
                saveMembers();
                displayMembers();
                showAlert('Membre supprimé avec succès !', 'success');
            }
        }

        // Afficher le modal QR
        function showQRModal(id) {
            const member = membersData.find(m => m.id === id);
            if (!member) return;

            document.getElementById('qrMemberName').textContent = member.full_name;
            
            // Générer le QR code
            const qrContainer = document.getElementById('qrCodeContainer');
            qrContainer.innerHTML = '';
            
            const memberUrl = `${window.location.origin}/member/${member.id}.html`;
            
            // Créer un canvas pour le QR code
            const canvas = document.createElement('canvas');
            qrContainer.appendChild(canvas);
            
            QRCode.toCanvas(canvas, memberUrl, {
                width: 200,
                height: 200,
                color: {
                    dark: '#8B1538',
                    light: '#FFFFFF'
                },
                margin: 2
            }, function (error) {
                if (error) {
                    console.error('Erreur génération QR:', error);
                    qrContainer.innerHTML = '<p>Erreur lors de la génération du QR code</p>';
                } else {
                    console.log('QR code généré avec succès');
                }
            });

            currentQRCode = memberUrl;
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        }

        // Télécharger le QR code
        function downloadQR() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qr-${document.getElementById('qrMemberName').textContent.replace(/\s+/g, '-')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        // Imprimer le QR code
        function printQR() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            if (canvas) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head><title>QR Code - ${document.getElementById('qrMemberName').textContent}</title></head>
                        <body style="text-align: center; padding: 20px;">
                            <h2>QR Code - ${document.getElementById('qrMemberName').textContent}</h2>
                            <img src="${canvas.toDataURL()}" style="max-width: 100%;">
                            <p>Scannez ce QR code pour accéder au profil</p>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }
        }

        // Sauvegarder les membres
        function saveMembers() {
            const data = {
                members: membersData,
                settings: {
                    admin_password: "JeunAct2024Admin",
                    site_url: window.location.origin
                }
            };
            
            localStorage.setItem('jeunact_members', JSON.stringify(data));
            showAlert('Données sauvegardées avec succès !', 'success');
        }

        // Réinitialiser les données
        function resetData() {
            if (confirm('Êtes-vous sûr de vouloir réinitialiser toutes les données ?')) {
                localStorage.removeItem('jeunact_members');
                membersData = [];
                displayMembers();
                showAlert('Données réinitialisées avec succès !', 'success');
            }
        }

        // Afficher une alerte
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        <div>${message}</div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsContainer.innerHTML = alertHTML;
            
            // Auto-supprimer après 5 secondes
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
